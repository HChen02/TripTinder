<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dream Vacation Vote</title> <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* Slightly nicer font */
      padding: 1.5em; /* Increased padding */
      background-color: var(--tg-theme-bg-color);
      color: var(--tg-theme-text-color);
      line-height: 1.6; /* Improved readability */
    }

    h2 {
      color: var(--tg-theme-text-color);
      margin-bottom: 0.2em; /* Adjust spacing below title */
    }

    .description {
      color: var(--tg-theme-hint-color); /* Use hint color for description */
      margin-top: 0;
      margin-bottom: 1.5em; /* Spacing before the form */
    }

    .grade-explanation {
        background-color: var(--tg-theme-secondary-bg-color);
        border: 1px solid var(--tg-theme-border-color);
        padding: 1em;
        margin-bottom: 1.5em;
        border-radius: 8px; /* Rounded corners */
        font-size: 0.9em;
        color: var(--tg-theme-text-color);
    }

    .grade-explanation strong {
        color: var(--tg-theme-link-color); /* Highlight numbers */
    }


    label {
      display: block;
      margin: 1em 0 0.4em 0; /* More space above labels */
      font-weight: bold;
      color: var(--tg-theme-text-color);
    }

     input[type="text"],
     select {
      display: block;
      width: 100%;
      padding: 0.75em; /* Increased padding */
      margin: 0.5em 0 1em 0; /* More space below inputs/selects */
      box-sizing: border-box;
      border: 1px solid var(--tg-theme-border-color);
      background-color: var(--tg-theme-secondary-bg-color);
      color: var(--tg-theme-text-color);
      border-radius: 4px; /* Slightly rounded inputs */
      -webkit-appearance: none; /* Remove default browser styles */
      -moz-appearance: none;
      appearance: none;
     }

     select {
         /* Add a custom arrow for select */
        background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg xmlns="http://www.w3.org/2000/svg" width="292.4" height="292.4"%3E%3Cpath fill="%23000000" d="M287,114.7L159.7,242c-2.4,2.4-5.8,4-9.3,4s-6.9-1.6-9.3-4L5.4,114.7c-4.9-4.9-5.1-12.3-0.4-17.2c4.5-4.7,11.7-4.9,16.5-0.4l137.5,137L270.5,97.1c4.9-4.5,12.3-4.3,17.2,0.4C292.1,102.4,291.9,109.8,287,114.7z"%3E%3C/path%3E%3C/svg%3E');
        background-repeat: no-repeat;
        background-position: right 0.7em top 50%;
        background-size: 0.65em auto;
        padding-right: 2.5em; /* Make space for the arrow */
     }

    .rating-options {
      display: flex;
      align-items: center;
      gap: 1em; /* Increased gap */
      flex-wrap: wrap;
      margin: 0.5em 0 1em 0; /* Space below price options */
    }

    .rating-option-item {
        display: inline-flex;
        align-items: center;
        cursor: pointer;
        background-color: var(--tg-theme-secondary-bg-color);
        border: 1px solid var(--tg-theme-border-color);
        padding: 0.75em 1em; /* Padding around radio options */
        border-radius: 6px; /* Rounded corners for option boxes */
        transition: background-color 0.2s ease;
    }

    .rating-option-item:hover {
         background-color: var(--tg-theme-border-color); /* Subtle hover effect */
    }

    .rating-option-item input[type="radio"] {
         margin-right: 0.5em; /* Space between radio and text */
         cursor: pointer;
         /* Custom radio button styling (optional, can get complex cross-browser) */
         /* For simplicity, keeping default radio appearance but styling the container */
    }

     .rating-option-item label {
        font-weight: normal;
        margin: 0; /* Reset margins */
        display: inline; /* Keep label inline with radio */
        cursor: pointer;
        color: var(--tg-theme-text-color);
    }


    #submit {
       display: none; /* Hide the old HTML submit button */
    }

    .error { color: var(--tg-theme-destructive-text-color); }
    strong { color: var(--tg-theme-link-color); }

  </style>
</head>
<body>
  <h2>Vote Your Dream Getaway</h2> <p class="description">Help us pick our next team adventure! Vote on how important each factor is to you. Don't worry, we'll try to find somewhere with decent Wi-Fi.</p> <div id="content">
    <p>Calculating optimal caffeine-to-progress ratioâ€¦</p> </div>

  <div class="grade-explanation">
       <p><strong>Quick Guide to Your Grades:</strong> (For everything except budget, 'cause money's just numbers, right? ðŸ˜‰)</p>
       <ul>
           <li><strong>1</strong>: "Meh, I can live without it." - Not a dealbreaker, probably spent all night debugging anyway.</li>
           <li><strong>2</strong>: "Nice to have." - Like finding an extra sticker at a conference.</li>
           <li><strong>3</strong>: "Pretty important." - You'd actively look for this feature, but won't crash the app if it's missing.</li>
           <li><strong>4</strong>: "Crucial!" - This is a key factor, equivalent to finding that one missing semicolon.</li>
           <li><strong>5</strong>: "Absolutely non-negotiable!" - This is the core requirement, without which, you might as well just reboot the whole hackathon.</li>
       </ul>
   </div>


  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();          // full-screen
    // We will use the Telegram MainButton for submission now
    // tg.MainButton.hide(); // Initial state is handled by updateMainButton

    // Utility: get ?session_id=â€¦
    function getSessionId() {
      const params = new URLSearchParams(window.location.search);
      return params.get('session_id');
    }

    const sessionId = getSessionId();
    const content = document.getElementById('content');

    if (!sessionId) {
      content.innerHTML = '<p class="error">Error: <strong>session_id</strong> missing. Did you deploy correctly?</p>'; // Added joke
      tg.MainButton.hide(); // Hide button on error
      throw new Error('No session_id');
    }

    // Function to update MainButton state
    function updateMainButton() {
        const nameInput = document.getElementById('name');
        // Name is required
        if (!nameInput || !nameInput.value.trim()) {
            tg.MainButton.hide();
            return;
        }
        const form = document.getElementById('vote-form');
        if (!form) {
             tg.MainButton.hide();
             return;
        }

        const fields = JSON.parse(form.dataset.fields || '[]');
        let allRated = true;

        fields.forEach(field => {
            // Ensure field is a string
            if (typeof field !== 'string') {
                allRated = false; // Cannot rate invalid field
                console.error("Unexpected field type encountered:", field, typeof field);
                return; // Skip this field
            }

            if (field === 'price' || field === 'budget') { // Added 'budget' check as it might be used instead of 'price'
                // For 'price' or 'budget' (radio buttons)
                const radios = document.querySelectorAll(`input[name="crit_${field}"]`);
                let fieldRated = false;
                radios.forEach(radio => {
                    if (radio.checked) {
                        fieldRated = true;
                    }
                });
                 if (!fieldRated) {
                    allRated = false;
                }
            } else {
                // For other fields (select dropdown 1-5)
                const select = document.getElementById(`crit_${field}`);
                 // Check if select exists and has a value selected (even default 1)
                if (!select || select.value === "") { // Added select.value check just in case, though 1-5 always has value
                    allRated = false; // Select element not found or no value, mark as not rated
                    console.warn(`Select element for ${field} not found or no value selected.`);
                }
            }
        });

        if (allRated) {
            tg.MainButton.setText('SUBMIT VOTE'); // Standard text
            // tg.MainButton.setText('DEPLOY VOTE ðŸš€'); // Hackathon version? ðŸ˜‰
            tg.MainButton.show();
            tg.MainButton.enable();
        } else {
            tg.MainButton.hide();
        }
    }


    // Fetch the criteria list from your API
    fetch(`/api/session/${encodeURIComponent(sessionId)}`)
      .then(res => {
        if (!res.ok) throw new Error('Session not found or not open. Did someone push to main?'); // Added joke
        return res.json();
      })
      .then(data => {
        const fields = data.fields; // e.g. ["beach","great_food",â€¦]

        // --- Add check for fields data type ---
        if (!Array.isArray(fields) || fields.some(field => typeof field !== 'string')) {
            console.error("API returned invalid fields data:", fields);
            content.innerHTML = '<p class="error">Error: Invalid criteria data from server. It\'s probably a caching issue... or not. Please contact the bot owner.</p>'; // Added joke
            tg.MainButton.hide();
            return; // Stop execution
        }
        // --- End of check ---


        if (!fields || fields.length === 0) {
            content.innerHTML = '<p class="error">No criteria defined for this session. Looks like an empty repo.</p>'; // Added joke
            tg.MainButton.hide(); // Hide button if no criteria
            return;
        }

        // Build form
        const form = document.createElement('form');
        form.id = 'vote-form';
        // Store fields on the form element for easy access in updateMainButton
        form.dataset.fields = JSON.stringify(fields);


        // Name input
        const nameLabel = document.createElement('label');
        nameLabel.htmlFor = 'name';
        nameLabel.textContent = 'Your Name (handle?):'; // Added joke
        form.appendChild(nameLabel);
        const nameInput = document.createElement('input');
        nameInput.id = 'name';
        nameInput.type = 'text';
        nameInput.placeholder = 'e.g., BugHunter42'; // Added joke
        nameInput.required = true;
        form.appendChild(nameInput);

        // Add event listener to update button state when name changes
        nameInput.addEventListener('input', updateMainButton);


        // Loop through fields and create appropriate inputs
        fields.forEach(field => {
          // --- Add check before processing field ---
          if (typeof field !== 'string') {
               console.error("Skipping non-string field:", field, typeof field);
               return; // Skip this iteration if field is not a string
          }
          // --- End of check ---

          const label = document.createElement('label');
          // Use field.replace to make the label more readable
          label.textContent = field.replace(/_/g,' ').replace(/\b\w/g, c => c.toUpperCase()) + ':';
          form.appendChild(label);


          // --- Conditional rendering based on field name ('price' or 'budget') ---
          if (field === 'price' || field === 'budget') { // Added 'budget' check
            // Use radio buttons for the 'price' or 'budget' field with specific values
            const optionsDiv = document.createElement('div');
            optionsDiv.classList.add('rating-options');

            // Define the specific price/budget values - these should ideally come from data, but using hardcoded for example
            const priceValues = [500, 1000, 1500, 2000, 2500]; // Example values

            priceValues.forEach(priceValue => {
                const radioItem = document.createElement('div'); // Wrapper div for styling
                radioItem.classList.add('rating-option-item');

                const radioInput = document.createElement('input');
                radioInput.type = 'radio';
                radioInput.id = `crit_${field}_${priceValue}`; // Use priceValue in ID for uniqueness
                radioInput.name = `crit_${field}`; // Use the same name for grouping
                radioInput.value = priceValue; // Set the value to the price value

                const radioLabel = document.createElement('label');
                radioLabel.htmlFor = `crit_${field}_${priceValue}`; // Use priceValue in htmlFor
                radioLabel.textContent = priceValue; // Set the label text to the price value
                // radioLabel.appendChild(radioInput); // Append input *before* label text for better visual layout

                radioItem.appendChild(radioInput);
                radioItem.appendChild(radioLabel); // Append label text

                optionsDiv.appendChild(radioItem); // Append the wrapper div

                // Add event listener to update button state
                radioInput.addEventListener('change', updateMainButton);
            });
             form.appendChild(optionsDiv); // Append the div containing radio buttons
          } else {
            // Use select dropdown for 1 to 5 for all other fields
            const select = document.createElement('select');
            select.id = `crit_${field}`;
            // select.required = true; // Consider adding required for better validation

            // Add options 1 to 5
            for (let i = 1; i <= 5; i++) {
              const opt = document.createElement('option');
              opt.value = i;
              opt.textContent = i;
              select.appendChild(opt);
            }
            form.appendChild(select); // Append the select directly

            // Add event listener to update button state
             select.addEventListener('change', updateMainButton);
          }
          // --- End of Conditional rendering ---
        });

        // Replace loading text with the form
        content.innerHTML = '';
        content.appendChild(form);

        // Initial check for button state
        updateMainButton();


        // Handle Telegram MainButton click
        tg.MainButton.onClick(() => {
          const nameInput = document.getElementById('name');
          const name = nameInput.value.trim();
          if (!name) {
            alert('Please enter your name. The commit won\'t count otherwise!'); // Added joke
            return;
          }

          const weights = {};
          // Safely parse fields from dataset again
          const fieldsToSubmit = JSON.parse(form.dataset.fields || '[]');
          console.log("Fields to submit:", fieldsToSubmit); // Keep dev logging
          fieldsToSubmit.forEach(field => {
            // Ensure field is a string before querying
            if (typeof field === 'string') {
                let value = null;
                if (field === 'price' || field === 'budget') { // Added 'budget' check
                     // For 'price' or 'budget', find the checked radio button
                     const selectedRadio = document.querySelector(`input[name="crit_${field}"]:checked`);
                     if (selectedRadio) {
                         value = parseInt(selectedRadio.value, 10); // Parse the price value
                     } else {
                          console.warn(`No radio button selected for ${field}. This is unexpected.`); // Keep dev logging
                     }
                } else {
                    // For other fields, find the select dropdown
                    const select = document.getElementById(`crit_${field}`);
                    if (select) {
                        value = parseInt(select.value, 10); // Get value from select (1-5)
                    } else {
                         console.warn(`Select element not found for ${field}. Did the DOM tree refactor itself?`); // Added joke, keep dev logging
                    }
                }

                if (value !== null) {
                   weights[field] = value;
                } else {
                    // This case should ideally be prevented by updateMainButton
                    console.warn(`Could not get value for field: ${field}. Looks like a null pointer.`); // Added joke, keep dev logging
                }

            } else {
                console.warn("Skipping non-string field during submission:", field, typeof field); // Keep dev logging
            }
          });

          const payload = {
            session_id: sessionId,
            name:       name,
            weights:    weights
          };
          tg.sendData(JSON.stringify(payload));
          tg.close(); // Close the Web App
        });
      })
      .catch(err => {
        console.error(err); // Keep dev logging
        content.innerHTML = `<p class="error">Failed to load session: ${err.message}. Looks like a backend issue... or CORS. Please contact the bot owner.</p>`; // Added joke
        tg.MainButton.hide(); // Hide button on fetch error
      });
  </script>
</body>
</html>